// Complete Prisma Schema - Full File

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  VENDOR
  CLIENT
  ADMIN
}

enum VendorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
}

enum ServiceRequestStatus {
  ACTIVE
  FULFILLED
  CLOSED
  EXPIRED
}

enum ServiceRequestUrgency {
  LOW
  MEDIUM
  HIGH
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum ApprovalStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum PayoutStatus {
  HELD
  RELEASED_TO_VENDOR
  COMPLETED
}

model User {
  id                  String        @id @default(cuid())
  email               String        @unique
  password            String
  firstName           String
  lastName            String
  phoneNumber         String
  avatarUrl           String?
  emailVerified       Boolean       @default(false)
  verificationToken   String?       @unique
  verificationExpiry  DateTime?
  activeRole          UserRole      @default(CLIENT)
  hasVendorProfile    Boolean       @default(false)
  hasClientProfile    Boolean       @default(true)
  isActive            Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  vendorProfile       VendorProfile?
  clientProfile       ClientProfile?
  roleSwitches        RoleSwitch[]
  sessions            Session[]
  refreshTokens       RefreshToken[]
  notifications       Notification[]
  clientBookings      Booking[]     @relation("ClientBookings")
  vendorBookings      Booking[]     @relation("VendorBookings")
  serviceRequests     ServiceRequest[]
  proposals           Proposal[]
  reviewsGiven        Review[]      @relation("ReviewsGiven")
  reviewsReceived     Review[]      @relation("ReviewsReceived")
  payments            Payment[]
  sentMessages        Message[]     @relation("SentMessages")
  receivedMessages    Message[]     @relation("ReceivedMessages")
  conversationsAsParticipant1 Conversation[] @relation("ConversationsAsParticipant1")
  conversationsAsParticipant2 Conversation[] @relation("ConversationsAsParticipant2")
  favoritesAsUser     Favorite[]    @relation("FavoriteUser")
  favoritesAsVendor   Favorite[]    @relation("FavoriteVendor")
  reportsMade         Report[]      @relation("ReportsMade")
  reportsReceived     Report[]      @relation("ReportsReceived")
  
  @@index([email])
  @@index([activeRole])
  @@index([verificationToken])
}

model RoleSwitch {
  id        String   @id @default(cuid())
  userId    String
  fromRole  UserRole
  toRole    UserRole
  switchedAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([switchedAt])
}

model VendorProfile {
  id              String        @id @default(cuid())
  userId          String        @unique
  businessName    String
  businessEmail   String        @unique
  businessPhone   String
  businessAddress String?
  city            String
  state           String?
  country         String        @default("UK")
  category        String
  description     String?
  website         String?
  status          VendorStatus  @default(PENDING)
  isVerified      Boolean       @default(false)
  rating          Float?        @default(0)
  totalReviews    Int           @default(0)
  serviceAreas    String[]
  portfolioImages String[]
  whatsappEnabled Boolean       @default(false)
  isOnline        Boolean       @default(false)
  responseTime    Int?          @default(24)
  minBookingPrice Float?
  maxBookingPrice Float?
  availability    Json?
  socialLinks     Json?
  businessProof   String?
  billingDetails  Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  servicePackages ServicePackage[]
  bookings        Booking[]     @relation("VendorProfileBookings")
  reviews         Review[]      @relation("VendorProfileReviews")
  proposals       Proposal[]    @relation("VendorProfileProposals")
  subscriptions   VendorSubscription[]
  
  @@index([businessName])
  @@index([city])
  @@index([category])
  @@index([status])
  @@index([rating])
}

model ClientProfile {
  id            String    @id @default(cuid())
  userId        String    @unique
  companyName   String?
  address       String?
  city          String?
  state         String?
  country       String?   @default("UK")
  eventTypes    String[]
  preferences   Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings      Booking[] @relation("ClientProfileBookings")
  reviews       Review[]  @relation("ClientProfileReviews")
  serviceRequests ServiceRequest[] @relation("ClientProfileServiceRequests")
  
  @@index([companyName])
}

model ServicePackage {
  id            String    @id @default(cuid())
  vendorId      String
  title         String
  description   String
  price         Float
  currency      String    @default("GBP")
  duration      Int
  inclusions    String[]
  isActive      Boolean   @default(true)
  aboutVendor   String?
  mainImage     String?
  gallery       String[]
  location      String?
  state         String?
  availability  Json?
  minBooking    Int?      @default(1)
  maxBooking    Int?
  preparationTime Int?    @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  vendor        VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  bookings      Booking[]
  
  @@index([vendorId])
  @@index([price])
  @@index([isActive])
}

model Booking {
  id                  String        @id @default(cuid())
  clientId            String
  vendorId            String
  vendorProfileId     String?
  clientProfileId     String?
  serviceId           String?
  serviceType         String
  eventDate           DateTime
  eventLocation       String
  guests              Int           @default(1)
  budget              Float
  quotedPrice         Float?
  message             String?
  customRequirements  String[]
  status              BookingStatus @default(PENDING)
  bookingDate         DateTime      @default(now())
  startTime           DateTime?
  endTime             DateTime?
  notes               String?
  paymentStatus       PaymentStatus @default(PENDING)
  commissionRate      Float         @default(0.15)
  commissionAmount    Float?
  serviceRequestId    String?
  proposalId          String?       @unique
  adjustedPrice       Float?
  priceAdjustmentReason String?
  clientApprovalStatus ApprovalStatus @default(PENDING_APPROVAL)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  client              User          @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  vendor              User          @relation("VendorBookings", fields: [vendorId], references: [id], onDelete: Cascade)
  vendorProfile       VendorProfile? @relation("VendorProfileBookings", fields: [vendorProfileId], references: [id])
  clientProfile       ClientProfile? @relation("ClientProfileBookings", fields: [clientProfileId], references: [id])
  servicePackage      ServicePackage? @relation(fields: [serviceId], references: [id])
  serviceRequest      ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  proposal            Proposal?     @relation(fields: [proposalId], references: [id])
  review              Review?
  payments            Payment[]
  
  @@index([clientId])
  @@index([vendorId])
  @@index([vendorProfileId])
  @@index([clientProfileId])
  @@index([eventDate])
  @@index([status])
  @@index([paymentStatus])
  @@index([bookingDate])
  @@index([serviceRequestId])
}

model Payment {
  id              String        @id @default(cuid())
  bookingId       String
  userId          String
  amount          Float
  currency        String        @default("GBP")
  paymentMethod   String
  stripePaymentId String?
  paypalOrderId   String?
  paypalPaymentId String?
  adminFee        Float?
  vendorPayout    Float?
  payoutStatus    PayoutStatus @default(HELD)
  status          PaymentStatus @default(PENDING)
  description     String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  payoutDate      DateTime?
  
  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model ServiceRequest {
  id              String                @id @default(cuid())
  clientId        String
  clientProfileId String?
  serviceType     String
  description     String
  budgetMin       Float
  budgetMax       Float
  eventDate       DateTime
  eventLocation   String
  guests          Int                   @default(1)
  requirements    String[]
  urgency         ServiceRequestUrgency @default(MEDIUM)
  status          ServiceRequestStatus  @default(ACTIVE)
  expiryDate      DateTime?
  isPublic        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  client          User                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientProfile   ClientProfile?        @relation("ClientProfileServiceRequests", fields: [clientProfileId], references: [id])
  proposals       Proposal[]
  bookings        Booking[]
  
  @@index([clientId])
  @@index([clientProfileId])
  @@index([serviceType])
  @@index([eventDate])
  @@index([status])
  @@index([urgency])
  @@index([createdAt])
  @@index([isPublic])
}

model Proposal {
  id              String        @id @default(cuid())
  vendorId        String
  vendorProfileId String?
  serviceRequestId String
  price           Float
  message         String
  inclusions      String[]
  exclusions      String[]
  deliveryTime    Int?
  revisions       Int?          @default(1)
  status          ProposalStatus @default(PENDING)
  isRead          Boolean       @default(false)
  expiresAt       DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  vendor          User          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorProfile   VendorProfile? @relation("VendorProfileProposals", fields: [vendorProfileId], references: [id])
  serviceRequest  ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  booking         Booking?
  
  @@index([vendorId])
  @@index([vendorProfileId])
  @@index([serviceRequestId])
  @@index([status])
  @@index([price])
  @@index([createdAt])
  @@index([expiresAt])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model RefreshToken {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model SubscriptionPlan {
  id          String    @id @default(cuid())
  name        String
  description String?
  price       Float
  currency    String    @default("GBP")
  duration    Int       @default(30)
  features    Json
  maxListings Int?      @default(3)
  maxBookings Int?      @default(10)
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  subscriptions VendorSubscription[]
  
  @@index([name])
  @@index([isActive])
  @@index([price])
}

model VendorSubscription {
  id              String   @id @default(cuid())
  vendorId        String
  planId          String
  status          String   @default("ACTIVE")
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  stripeSubscriptionId String?
  stripeCustomerId    String?
  trialEndsAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  vendor          VendorProfile @relation(fields: [vendorId], references: [id])
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  
  @@index([vendorId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model Review {
  id          String   @id @default(cuid())
  bookingId   String   @unique
  clientId    String
  vendorId    String
  clientProfileId String?
  vendorProfileId String?
  rating      Int      @default(5)
  title       String?
  comment     String?
  response    String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client      User     @relation("ReviewsGiven", fields: [clientId], references: [id], onDelete: Cascade)
  vendor      User     @relation("ReviewsReceived", fields: [vendorId], references: [id], onDelete: Cascade)
  clientProfile ClientProfile? @relation("ClientProfileReviews", fields: [clientProfileId], references: [id])
  vendorProfile VendorProfile? @relation("VendorProfileReviews", fields: [vendorProfileId], references: [id])
  
  @@index([vendorId])
  @@index([clientId])
  @@index([vendorProfileId])
  @@index([clientProfileId])
  @@index([rating])
  @@index([createdAt])
  @@index([isPublic])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String
  title       String
  message     String
  isRead      Boolean  @default(false)
  isSeen      Boolean  @default(false)
  actionUrl   String?
  data        Json?
  createdAt   DateTime @default(now())
  readAt      DateTime?
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}

model Message {
  id          String   @id @default(cuid())
  senderId    String
  receiverId  String
  conversationId String?
  bookingId   String?
  content     String
  isRead      Boolean  @default(false)
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  sender      User          @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User          @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation("ConversationMessages", fields: [conversationId], references: [id], onDelete: Cascade)
  lastMessageIn Conversation? @relation("LastMessage")
  
  @@index([senderId])
  @@index([receiverId])
  @@index([conversationId])
  @@index([bookingId])
  @@index([isRead])
  @@index([createdAt])
}

model Conversation {
  id             String    @id @default(cuid())
  participant1Id String
  participant2Id String
  bookingId      String?
  lastMessageId  String?   @unique
  unreadCount    Int       @default(0)
  lastActivityAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  participant1 User      @relation("ConversationsAsParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User      @relation("ConversationsAsParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  lastMessage  Message?  @relation("LastMessage", fields: [lastMessageId], references: [id])
  messages     Message[] @relation("ConversationMessages")
  
  @@unique([participant1Id, participant2Id, bookingId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([lastActivityAt])
}

model Favorite {
  id          String   @id @default(cuid())
  userId      String
  vendorId    String
  createdAt   DateTime @default(now())
  
  user        User     @relation("FavoriteUser", fields: [userId], references: [id], onDelete: Cascade)
  vendor      User     @relation("FavoriteVendor", fields: [vendorId], references: [id], onDelete: Cascade)
  
  @@unique([userId, vendorId])
  @@index([userId])
  @@index([vendorId])
}

model Report {
  id          String   @id @default(cuid())
  reporterId  String
  targetId    String
  targetType  String
  reason      String
  description String
  status      String   @default("PENDING")
  adminNotes  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  reporter    User     @relation("ReportsMade", fields: [reporterId], references: [id], onDelete: Cascade)
  targetUser  User?    @relation("ReportsReceived", fields: [targetId], references: [id], onDelete: Cascade)
  
  @@index([reporterId])
  @@index([targetId])
  @@index([status])
  @@index([createdAt])
}

model PlatformAnalytics {
  id          String   @id @default(cuid())
  date        DateTime @unique
  totalUsers  Int      @default(0)
  totalVendors Int     @default(0)
  totalBookings Int    @default(0)
  totalRevenue Float   @default(0)
  newUsers    Int      @default(0)
  newVendors  Int      @default(0)
  completedBookings Int @default(0)
  cancelledBookings Int @default(0)
  avgRating   Float?   @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([date])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([isActive])
}

model NewsletterSubscriber {
  id           String   @id @default(cuid())
  email        String   @unique
  subscribedAt DateTime @default(now())
  isActive     Boolean  @default(true)

  @@index([email])
}